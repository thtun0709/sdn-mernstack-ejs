<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title><%= perfume.name %></title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      background: #0c0c0c;
      color: #fff;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }

    .container {
      width: 90%;
      max-width: 1000px;
      margin: 50px auto;
    }

    .detail {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
      align-items: flex-start;
    }

    .detail img {
      width: 380px;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid #2a2a2a;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    .info { flex: 1; min-width: 300px; }
    .info h1 { font-size: 26px; margin-bottom: 10px; }

    .price {
      color: #c41e3a;
      font-weight: 600;
      font-size: 22px;
      margin: 15px 0;
    }

    .rating { margin-top: 10px; font-size: 20px; color: #f5c518; }

    /* Comment */
    .comment-section { margin-top: 60px; }
    .comment-section h2 {
      border-left: 4px solid #c41e3a;
      padding-left: 12px;
      margin-bottom: 20px;
      font-size: 20px;
    }

    .comment {
      background: #151515;
      border: 1px solid #222;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 12px;
      position: relative;
    }

    .comment small { color: #aaa; display: block; margin-top: 8px; font-size: 13px; }

    .comment-form textarea,
    .edit-form textarea {
      width: 100%;
      background: #111;
      color: #fff;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 10px;
      resize: none;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .comment-form select, .edit-form select {
      background: #111;
      color: #fff;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 10px;
    }

    .comment-form button, .edit-form button {
      background: #c41e3a;
      color: #fff;
      border: none;
      padding: 8px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: 0.3s;
    }

    .comment-form button:hover, .edit-form button:hover {
      background: #a0142e;
    }

    .comment-actions a {
      color: #c41e3a;
      font-size: 13px;
      margin-right: 10px;
      cursor: pointer;
      text-decoration: none;
    }

    .comment-actions a:hover { text-decoration: underline; }

    .edit-form { display: none; margin-top: 10px; }
  </style>
</head>

<body>
  <%- include('../partials/header') %>

  <div class="container">
    <!-- Chi ti·∫øt n∆∞·ªõc hoa -->
    <div class="detail">
      <img src="<%= perfume.image %>" alt="<%= perfume.name %>">
      <div class="info">
        <h1><%= perfume.name %></h1>
        <p><b>Brand:</b> <%= perfume.brand %></p>
        <p><b>Gender:</b> <%= perfume.gender %></p>
        <p class="price"><%= perfume.price.toLocaleString() %> VND</p>
        <p><%= perfume.description || "No description for this product." %></p>

        <div class="rating">
          <% if (typeof ratingsCount !== 'undefined' && ratingsCount > 0) { %>
            ‚≠ê Trung b√¨nh: <%= avgRating.toFixed(1) %>/3 (t·ª´ <%= ratingsCount %> ƒë√°nh gi√°)
          <% } else { %>
            ‚≠ê Trung b√¨nh: Ch∆∞a c√≥
          <% } %>
        </div>
      </div>
    </div>

    <!-- B√¨nh lu·∫≠n -->
    <div class="comment-section">
      <h2>Comments</h2>

      <% if (member) { %>
        <form class="comment-form" action="/perfumes/<%= perfume._id %>/comment" method="POST">
          <label>ƒê√°nh gi√° (1‚Äì3 sao):</label>
          <select name="rating" required>
            <option value="1">‚≠ê 1</option>
            <option value="2">‚≠ê‚≠ê 2</option>
            <option value="3">‚≠ê‚≠ê‚≠ê 3</option>
          </select>
          <textarea name="content" rows="3" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." required></textarea>
          <button type="submit">G·ª≠i</button>
        </form>
      <% } else { %>
        <p><a href="/login?redirect=/perfumes/<%= perfume._id %>#comments" class="login-link">ƒêƒÉng nh·∫≠p</a> ƒë·ªÉ b√¨nh lu·∫≠n.</p>
      <% } %>

      <% if (comments && comments.length > 0) { %>
        <% comments.forEach(c => { %>
          <div class="comment" id="comment-<%= c._id %>">
            <p><%= c.content %></p>
            <p>ƒê√°nh gi√°: <%= c.rating %> ‚≠ê</p>
            <small>üë§ <%= c.userId.name %> | üïí <%= new Date(c.createdAt).toLocaleString() %></small>

            <% if (member && (member._id.toString() === c.userId._id.toString() || member.role === 'admin')) { %>
              <div class="comment-actions">
                <a href="/comments/delete/<%= c._id %>" onclick="return confirm('X√≥a b√¨nh lu·∫≠n n√†y?')">üóë X√≥a</a>
                <a class="edit-link" data-id="<%= c._id %>">‚úèÔ∏è S·ª≠a</a>
              </div>

              <form action="/comments/edit/<%= c._id %>" method="POST" class="edit-form" id="edit-form-<%= c._id %>">
                <textarea name="content" rows="2"><%= c.content %></textarea>
                <label>ƒê√°nh gi√°:</label>
                <select name="rating">
                  <option value="1" <%= c.rating === 1 ? 'selected' : '' %>>‚≠ê 1</option>
                  <option value="2" <%= c.rating === 2 ? 'selected' : '' %>>‚≠ê‚≠ê 2</option>
                  <option value="3" <%= c.rating === 3 ? 'selected' : '' %>>‚≠ê‚≠ê‚≠ê 3</option>
                </select>
                <button type="submit">üíæ C·∫≠p nh·∫≠t</button>
              </form>
            <% } %>
          </div>
        <% }) %>
      <% } else { %>
        <p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>
      <% } %>
    </div>
  </div>

  <%- include('../partials/footer') %>

  <script>
    // Hi·ªÉn th·ªã popup n·∫øu c√≥ l·ªói from server
    (function() {
      var error = '<%= error || "" %>';
      if (error === 'already_commented') {
        alert('B·∫°n ƒë√£ comment s·∫£n ph·∫©m n√†y r·ªìi');
      }
    })();

    // B·∫≠t/t·∫Øt form s·ª≠a
    document.querySelectorAll('.edit-link').forEach(btn => {
      btn.addEventListener('click', function () {
        const id = this.dataset.id;
        const form = document.getElementById(`edit-form-${id}`);
        if (form.style.display === 'block') {
          form.style.display = 'none';
        } else {
          form.style.display = 'block';
        }
      });
    });
  </script>
</body>
</html>
